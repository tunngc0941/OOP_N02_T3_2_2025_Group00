<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>üí∞ Qu·∫£n l√Ω Giao d·ªãch - Shop Gi√†y THN</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: #f7f5f2;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      .navbar-custom {
        background-color: #2c3e50;
      }
      .navbar-custom .nav-link,
      .navbar-custom .navbar-brand {
        color: #ecf0f1;
        font-weight: 600;
      }
      .navbar-custom .nav-link:hover {
        color: #f39c12;
      }
      header {
        background: url('https://images.unsplash.com/photo-1576491110919-df70d852860f?q=80&w=1172&auto=format&fit=crop')
          center/cover no-repeat;
        height: 200px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.7);
      }
      header h1 {
        font-size: 3rem;
        background: rgba(44, 62, 80, 0.7);
        padding: 15px 30px;
        border-radius: 12px;
      }
      .table-img {
        width: 60px;
        height: 40px;
        object-fit: contain;
        border-radius: 4px;
      }
      .form-control-sm {
        max-width: 150px;
      }
      .btn-sm {
        min-width: 70px;
      }
      .section-title {
        margin-top: 30px;
        margin-bottom: 20px;
        font-weight: 700;
        color: #34495e;
      }
      footer {
        margin-top: 60px;
        background: #2c3e50;
        color: #bdc3c7;
        padding: 15px 0;
        text-align: center;
        font-size: 0.9rem;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-custom">
      <div class="container">
        <a class="navbar-brand" href="#">üè† Shop Gi√†y THN</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navMain"
        >
          <span class="navbar-toggler-icon"
            ><i class="bi bi-list" style="font-size: 1.5rem; color: #ecf0f1"></i
          ></span>
        </button>
        <div class="collapse navbar-collapse" id="navMain">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="/main">Trang ch·ªß</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/sanpham">S·∫£n ph·∫©m</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="/khachhang">Kh√°ch h√†ng</a>
            </li>
            <li class="nav-item">
              <a class="nav-link active" href="/giaodich">Giao d·ªãch</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>

    <!-- Banner -->
    <header>
      <h1>Qu·∫£n l√Ω Giao d·ªãch</h1>
    </header>

    <!-- Main content -->
    <main class="container my-4">
      <h2 class="section-title text-center">Danh s√°ch Giao d·ªãch</h2>

      <!-- Search & Add -->
      <div
        class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2"
      >
        <input
          type="text"
          id="searchInput"
          placeholder="T√¨m theo m√£ GD, t√™n KH ho·∫∑c s·∫£n ph·∫©m..."
          class="form-control form-control-sm"
          style="max-width: 300px"
        />
        <button
          class="btn btn-success btn-sm"
          data-bs-toggle="modal"
          data-bs-target="#transactionModal"
          id="btnAddTransaction"
        >
          <i class="bi bi-plus-lg"></i> Th√™m giao d·ªãch
        </button>
      </div>

      <!-- Table giao d·ªãch -->
      <div class="table-responsive mb-4">
        <table class="table table-striped table-bordered align-middle">
          <thead class="table-dark">
            <tr>
              <th>M√£ GD</th>
              <th>Ng√†y</th>
              <th>Kh√°ch h√†ng</th>
              <th>S·∫£n ph·∫©m</th>
              <th>S·ªë l∆∞·ª£ng</th>
              <th>Th√†nh ti·ªÅn</th>
              <th>H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="transaction-list">
            <!-- D·ªØ li·ªáu giao d·ªãch s·∫Ω load v√†o ƒë√¢y -->
          </tbody>
        </table>
      </div>

      <!-- Th·ªëng k√™ -->
      <div class="card p-3 mb-4 shadow-sm">
        <h4 class="mb-3">Th·ªëng k√™</h4>
        <div class="row">
          <div class="col-md-4">
            <div class="card bg-primary text-white p-3">
              <h5 class="card-title">T·ªïng giao d·ªãch</h5>
              <h3 id="totalTransactions" class="card-text">0</h3>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card bg-success text-white p-3">
              <h5 class="card-title">T·ªïng doanh thu</h5>
              <h3 id="totalRevenue" class="card-text">0 ‚Ç´</h3>
            </div>
          </div>
          <div class="col-md-4">
            <div class="card bg-info text-white p-3">
              <h5 class="card-title">T·ªïng s·∫£n ph·∫©m ƒë√£ b√°n</h5>
              <h3 id="totalProductsSold" class="card-text">0</h3>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Modal th√™m/s·ª≠a giao d·ªãch -->
    <div
      class="modal fade"
      id="transactionModal"
      tabindex="-1"
      aria-labelledby="transactionModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog modal-lg">
        <form id="transactionForm" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="transactionModalLabel">Th√™m giao d·ªãch</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="ƒê√≥ng"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="originalMaGd" />
            <div class="row">
              <div class="col-md-6 mb-3">
                <label for="maGd" class="form-label">M√£ giao d·ªãch</label>
                <input
                  type="text"
                  class="form-control"
                  id="maGd"
                  required
                />
              </div>
              <div class="col-md-6 mb-3">
                <label for="ngayGd" class="form-label">Ng√†y giao d·ªãch</label>
                <input
                  type="date"
                  class="form-control"
                  id="ngayGd"
                  required
                />
              </div>
            </div>
            <div class="mb-3">
              <label for="khachHang" class="form-label">Kh√°ch h√†ng</label>
              <select class="form-select" id="khachHang" required>
                <option value="">Ch·ªçn kh√°ch h√†ng</option>
                <!-- Options s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
              </select>
            </div>
            <div class="mb-3">
              <label class="form-label">S·∫£n ph·∫©m</label>
              <div class="table-responsive">
                <table class="table table-bordered">
                  <thead>
                    <tr>
                      <th>S·∫£n ph·∫©m</th>
                      <th>Gi√°</th>
                      <th>S·ªë l∆∞·ª£ng</th>
                      <th>Th√†nh ti·ªÅn</th>
                      <th>H√†nh ƒë·ªông</th>
                    </tr>
                  </thead>
                  <tbody id="productItems">
                    <!-- S·∫£n ph·∫©m s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                  </tbody>
                  <tfoot>
                    <tr>
                      <td colspan="3" class="text-end fw-bold">T·ªïng c·ªông:</td>
                      <td id="totalAmount" class="fw-bold">0 ‚Ç´</td>
                      <td></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              <div class="d-flex gap-2 mt-2">
                <select class="form-select" id="productSelect">
                  <option value="">Ch·ªçn s·∫£n ph·∫©m</option>
                  <!-- Options s·∫Ω ƒë∆∞·ª£c th√™m b·∫±ng JS -->
                </select>
                <input
                  type="number"
                  id="productQuantity"
                  class="form-control"
                  placeholder="S·ªë l∆∞·ª£ng"
                  min="1"
                  style="width: 100px"
                />
                <button
                  type="button"
                  class="btn btn-primary btn-sm"
                  id="btnAddProduct"
                >
                  Th√™m
                </button>
              </div>
            </div>
            <div
              id="formAlert"
              class="alert alert-danger d-none"
              role="alert"
            ></div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary btn-sm"
              data-bs-dismiss="modal"
            >
              H·ªßy
            </button>
            <button type="submit" class="btn btn-primary btn-sm">L∆∞u</button>
          </div>
        </form>
      </div>
    </div>

    <footer>&copy; 2025 Shop Gi√†y THN - H·ªá th·ªëng qu·∫£n l√Ω b√°n h√†ng</footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // DOM Elements
      const transactionList = document.getElementById('transaction-list');
      const searchInput = document.getElementById('searchInput');
      const btnAddTransaction = document.getElementById('btnAddTransaction');
      const transactionModal = new bootstrap.Modal(
        document.getElementById('transactionModal')
      );
      const transactionForm = document.getElementById('transactionForm');
      const formAlert = document.getElementById('formAlert');
      const originalMaGd = document.getElementById('originalMaGd');
      const maGdInput = document.getElementById('maGd');
      const ngayGdInput = document.getElementById('ngayGd');
      const khachHangSelect = document.getElementById('khachHang');
      const productSelect = document.getElementById('productSelect');
      const productQuantity = document.getElementById('productQuantity');
      const btnAddProduct = document.getElementById('btnAddProduct');
      const productItems = document.getElementById('productItems');
      const totalAmount = document.getElementById('totalAmount');

      // Stats elements
      const totalTransactionsEl = document.getElementById('totalTransactions');
      const totalRevenueEl = document.getElementById('totalRevenue');
      const totalProductsSoldEl = document.getElementById('totalProductsSold');

      // Data
      let giaoDichData = JSON.parse(localStorage.getItem('giaoDichData')) || [];
      let khachHangData =
        JSON.parse(localStorage.getItem('khachHangData')) ||
        [
          { ten: 'Nguy·ªÖn VƒÉn A', sdt: '0912345678' },
          { ten: 'Tr·∫ßn Th·ªã B', sdt: '0987654321' },
          { ten: 'Ph·∫°m VƒÉn C', sdt: '0905123456' },
          { ten: 'L√™ Th·ªã D', sdt: '0933344455' },
        ];
      let sanPhamData =
        JSON.parse(localStorage.getItem('sanPhamData')) ||
        [
          {
            maSp: 'SP001',
            name: 'Gi√†y Sneaker Nam Tr·∫Øng',
            price: 650000,
            size: 42,
            imageURL: 'https://via.placeholder.com/100x60?text=Sneaker+Tr·∫Øng',
          },
          {
            maSp: 'SP002',
            name: 'Gi√†y Th·ªÉ Thao N·ªØ H·ªìng',
            price: 720000,
            size: 38,
            imageURL: 'https://via.placeholder.com/100x60?text=Sneaker+H·ªìng',
          },
          {
            maSp: 'SP003',
            name: 'Gi√†y ƒê√° Banh Nike',
            price: 1250000,
            size: 43,
            imageURL: 'https://via.placeholder.com/100x60?text=Nike+Football',
          },
          {
            maSp: 'SP004',
            name: 'Gi√†y T√¢y Da ƒêen',
            price: 890000,
            size: 41,
            imageURL: 'https://via.placeholder.com/100x60?text=Gi√†y+T√¢y',
          },
          {
          maSp: 'SP005',
          name: 'Gi√†y Th·ªÉ Thao Nam',
          price: 850000,
          size: 41,
          imageURL: 'https://images.unsplash.com/photo-1542291026-7eec264c27ff?auto=format&fit=crop&w=400&q=80',
        },
        {
        maSp: 'SP006',
          name: 'Gi√†y Th·ªÉ Thao N·ªØ',
          price: 850000,
          size: 39,
          imageURL: 'https://images.unsplash.com/photo-1511556532299-8f662fc26c06?q=80&w=2070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D',
        },
        ];

      // Current transaction items
      let currentItems = [];

      // H√†m l∆∞u d·ªØ li·ªáu v√†o localStorage
      function saveData() {
        localStorage.setItem('giaoDichData', JSON.stringify(giaoDichData));
      }

      // Load d·ªØ li·ªáu kh√°ch h√†ng v√†o select
      function loadKhachHangOptions() {
        khachHangSelect.innerHTML = '<option value="">Ch·ªçn kh√°ch h√†ng</option>';
        khachHangData.forEach((kh) => {
          khachHangSelect.innerHTML += `<option value="${kh.sdt}">${kh.ten} (${kh.sdt})</option>`;
        });
      }

      // Load d·ªØ li·ªáu s·∫£n ph·∫©m v√†o select
      function loadSanPhamOptions() {
        productSelect.innerHTML = '<option value="">Ch·ªçn s·∫£n ph·∫©m</option>';
        sanPhamData.forEach((sp) => {
          productSelect.innerHTML += `<option value="${sp.maSp}">${sp.name} - ${sp.price.toLocaleString('vi-VN')} ‚Ç´</option>`;
        });
      }

      // Hi·ªÉn th·ªã danh s√°ch giao d·ªãch
      function loadGiaoDich() {
        transactionList.innerHTML = '';
        if (giaoDichData.length === 0) {
          transactionList.innerHTML = `<tr><td colspan="7" class="text-center">Ch∆∞a c√≥ giao d·ªãch n√†o.</td></tr>`;
          updateStats();
          return;
        }

        giaoDichData.forEach((gd) => {
          let productsHtml = '';
          gd.sanPham.forEach((sp) => {
            const product = sanPhamData.find((p) => p.maSp === sp.maSp);
            productsHtml += `
              <div class="d-flex align-items-center mb-1">
                <img src="${
                  product?.imageURL ||
                  'https://via.placeholder.com/60x40?text=No+Image'
                }" alt="${product?.name || sp.maSp}" class="table-img me-2">
                <div>
                  <div>${product?.name || sp.maSp}</div>
                  <small class="text-muted">${sp.soLuong} x ${sp.donGia.toLocaleString('vi-VN')} ‚Ç´</small>
                </div>
              </div>
            `;
          });

          const khachHang = khachHangData.find((kh) => kh.sdt === gd.sdtKhachHang);

          transactionList.innerHTML += `
            <tr>
              <td>${gd.maGd}</td>
              <td>${new Date(gd.ngayGd).toLocaleDateString('vi-VN')}</td>
              <td>${khachHang?.ten || 'Kh√°ch l·∫ª'} (${gd.sdtKhachHang})</td>
              <td>${productsHtml}</td>
              <td>${gd.sanPham.reduce(
                (total, sp) => total + sp.soLuong,
                0
              )}</td>
              <td>${gd.tongTien.toLocaleString('vi-VN')} ‚Ç´</td>
              <td>
                <button class="btn btn-sm btn-warning me-1" onclick="editGiaoDich('${
                  gd.maGd
                }')">
                  <i class="bi bi-pencil-fill"></i> S·ª≠a
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteGiaoDich('${
                  gd.maGd
                }')">
                  <i class="bi bi-trash-fill"></i> X√≥a
                </button>
              </td>
            </tr>
          `;
        });

        updateStats();
      }

      // C·∫≠p nh·∫≠t th·ªëng k√™
      function updateStats() {
        totalTransactionsEl.textContent = giaoDichData.length;
        const revenue = giaoDichData.reduce(
          (total, gd) => total + gd.tongTien,
          0
        );
        totalRevenueEl.textContent = revenue.toLocaleString('vi-VN') + ' ‚Ç´';
        const productsSold = giaoDichData.reduce(
          (total, gd) =>
            total + gd.sanPham.reduce((sum, sp) => sum + sp.soLuong, 0),
          0
        );
        totalProductsSoldEl.textContent = productsSold;
      }

      // T√≠nh t·ªïng ti·ªÅn cho c√°c s·∫£n ph·∫©m hi·ªán t·∫°i
      function calculateTotal() {
        const total = currentItems.reduce(
          (sum, item) => sum + item.donGia * item.soLuong,
          0
        );
        totalAmount.textContent = total.toLocaleString('vi-VN') + ' ‚Ç´';
        return total;
      }

      // Hi·ªÉn th·ªã s·∫£n ph·∫©m ƒë√£ ch·ªçn
      function renderSelectedProducts() {
        productItems.innerHTML = '';
        currentItems.forEach((item, index) => {
          const product = sanPhamData.find((p) => p.maSp === item.maSp);
          productItems.innerHTML += `
            <tr>
              <td>${product?.name || item.maSp}</td>
              <td>${item.donGia.toLocaleString('vi-VN')} ‚Ç´</td>
              <td>
                <input type="number" class="form-control form-control-sm quantity-input" 
                  value="${item.soLuong}" min="1" data-index="${index}">
              </td>
              <td>${(item.donGia * item.soLuong).toLocaleString('vi-VN')} ‚Ç´</td>
              <td>
                <button class="btn btn-sm btn-danger" onclick="removeProductItem(${index})">
                  <i class="bi bi-trash"></i>
                </button>
              </td>
            </tr>
          `;
        });

        // Th√™m s·ª± ki·ªán thay ƒë·ªïi s·ªë l∆∞·ª£ng
        document.querySelectorAll('.quantity-input').forEach((input) => {
          input.addEventListener('change', (e) => {
            const index = parseInt(e.target.dataset.index);
            currentItems[index].soLuong = parseInt(e.target.value);
            calculateTotal();
            renderSelectedProducts();
          });
        });

        calculateTotal();
      }

      // X√≥a s·∫£n ph·∫©m kh·ªèi danh s√°ch
      window.removeProductItem = function (index) {
        currentItems.splice(index, 1);
        renderSelectedProducts();
      };

      // Th√™m s·∫£n ph·∫©m v√†o danh s√°ch
      btnAddProduct.addEventListener('click', () => {
        const maSp = productSelect.value;
        const quantity = parseInt(productQuantity.value) || 1;

        if (!maSp) {
          alert('Vui l√≤ng ch·ªçn s·∫£n ph·∫©m');
          return;
        }

        if (quantity < 1) {
          alert('S·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0');
          return;
        }

        const product = sanPhamData.find((p) => p.maSp === maSp);
        if (!product) {
          alert('S·∫£n ph·∫©m kh√¥ng t·ªìn t·∫°i');
          return;
        }

        // Ki·ªÉm tra n·∫øu s·∫£n ph·∫©m ƒë√£ t·ªìn t·∫°i th√¨ c·ªông th√™m s·ªë l∆∞·ª£ng
        const existingItem = currentItems.find((item) => item.maSp === maSp);
        if (existingItem) {
          existingItem.soLuong += quantity;
        } else {
          currentItems.push({
            maSp: product.maSp,
            donGia: product.price,
            soLuong: quantity,
          });
        }

        productSelect.value = '';
        productQuantity.value = '';
        renderSelectedProducts();
      });

      // T√¨m ki·∫øm giao d·ªãch
      searchInput.addEventListener('input', () => {
        const keyword = searchInput.value.toLowerCase();
        const filtered = giaoDichData.filter((gd) => {
          const khachHang = khachHangData.find((kh) => kh.sdt === gd.sdtKhachHang);
          const khachHangText = khachHang
            ? `${khachHang.ten} ${khachHang.sdt}`.toLowerCase()
            : '';
          
          const sanPhamText = gd.sanPham
            .map((sp) => {
              const product = sanPhamData.find((p) => p.maSp === sp.maSp);
              return product ? product.name.toLowerCase() : sp.maSp.toLowerCase();
            })
            .join(' ');
          
          return (
            gd.maGd.toLowerCase().includes(keyword) ||
            khachHangText.includes(keyword) ||
            sanPhamText.includes(keyword)
          );
        });
        
        // Hi·ªÉn th·ªã k·∫øt qu·∫£ t√¨m ki·∫øm
        if (filtered.length === 0) {
          transactionList.innerHTML = `<tr><td colspan="7" class="text-center">Kh√¥ng t√¨m th·∫•y giao d·ªãch ph√π h·ª£p.</td></tr>`;
        } else {
          // C·∫≠p nh·∫≠t l·∫°i danh s√°ch v·ªõi k·∫øt qu·∫£ t√¨m ki·∫øm
          transactionList.innerHTML = '';
          filtered.forEach((gd) => {
            let productsHtml = '';
            gd.sanPham.forEach((sp) => {
              const product = sanPhamData.find((p) => p.maSp === sp.maSp);
              productsHtml += `
                <div class="d-flex align-items-center mb-1">
                  <img src="${
                    product?.imageURL ||
                    'https://via.placeholder.com/60x40?text=No+Image'
                  }" alt="${product?.name || sp.maSp}" class="table-img me-2">
                  <div>
                    <div>${product?.name || sp.maSp}</div>
                    <small class="text-muted">${sp.soLuong} x ${sp.donGia.toLocaleString('vi-VN')} ‚Ç´</small>
                  </div>
                </div>
              `;
            });

            const khachHang = khachHangData.find((kh) => kh.sdt === gd.sdtKhachHang);

            transactionList.innerHTML += `
              <tr>
                <td>${gd.maGd}</td>
                <td>${new Date(gd.ngayGd).toLocaleDateString('vi-VN')}</td>
                <td>${khachHang?.ten || 'Kh√°ch l·∫ª'} (${gd.sdtKhachHang})</td>
                <td>${productsHtml}</td>
                <td>${gd.sanPham.reduce(
                  (total, sp) => total + sp.soLuong,
                  0
                )}</td>
                <td>${gd.tongTien.toLocaleString('vi-VN')} ‚Ç´</td>
                <td>
                  <button class="btn btn-sm btn-warning me-1" onclick="editGiaoDich('${
                    gd.maGd
                  }')">
                    <i class="bi bi-pencil-fill"></i> S·ª≠a
                  </button>
                  <button class="btn btn-sm btn-danger" onclick="deleteGiaoDich('${
                    gd.maGd
                  }')">
                    <i class="bi bi-trash-fill"></i> X√≥a
                  </button>
                </td>
              </tr>
            `;
          });
        }
      });

      // M·ªü modal th√™m giao d·ªãch m·ªõi
      btnAddTransaction.addEventListener('click', () => {
        transactionForm.reset();
        formAlert.classList.add('d-none');
        document.querySelector('#transactionModal .modal-title').textContent =
          'Th√™m giao d·ªãch';
        originalMaGd.value = '';
        currentItems = [];
        renderSelectedProducts();
        maGdInput.disabled = false;
        // Set ng√†y m·∫∑c ƒë·ªãnh l√† h√¥m nay
        ngayGdInput.valueAsDate = new Date();
      });

      // S·ª≠a giao d·ªãch
      window.editGiaoDich = function (maGd) {
        formAlert.classList.add('d-none');
        const gd = giaoDichData.find((g) => g.maGd === maGd);
        if (!gd) return alert('Kh√¥ng t√¨m th·∫•y giao d·ªãch!');
        
        document.querySelector('#transactionModal .modal-title').textContent =
          'S·ª≠a giao d·ªãch';
        originalMaGd.value = gd.maGd;
        maGdInput.value = gd.maGd;
        ngayGdInput.value = new Date(gd.ngayGd).toISOString().split('T')[0];
        khachHangSelect.value = gd.sdtKhachHang;
        currentItems = [...gd.sanPham];
        renderSelectedProducts();
        maGdInput.disabled = true;
        transactionModal.show();
      };

      // X√≥a giao d·ªãch
      window.deleteGiaoDich = function (maGd) {
        if (!confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a giao d·ªãch ${maGd} kh√¥ng?`)) return;
        giaoDichData = giaoDichData.filter((g) => g.maGd !== maGd);
        saveData();
        loadGiaoDich();
      };

      // X·ª≠ l√Ω submit form
      transactionForm.addEventListener('submit', (e) => {
        e.preventDefault();
        formAlert.classList.add('d-none');
        
        const maGd = maGdInput.value.trim();
        const ngayGd = ngayGdInput.value;
        const sdtKhachHang = khachHangSelect.value.trim();
        
        if (!maGd || !ngayGd || !sdtKhachHang) {
          formAlert.textContent = 'Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin giao d·ªãch.';
          formAlert.classList.remove('d-none');
          return;
        }
        
        if (currentItems.length === 0) {
          formAlert.textContent = 'Vui l√≤ng th√™m √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m.';
          formAlert.classList.remove('d-none');
          return;
        }
        
        const tongTien = calculateTotal();
        const payload = {
          maGd,
          ngayGd: new Date(ngayGd).toISOString(),
          sdtKhachHang,
          sanPham: currentItems,
          tongTien,
        };
        
        if (originalMaGd.value) {
          // C·∫≠p nh·∫≠t
          const index = giaoDichData.findIndex((g) => g.maGd === originalMaGd.value);
          if (index !== -1) giaoDichData[index] = payload;
          alert('C·∫≠p nh·∫≠t giao d·ªãch th√†nh c√¥ng');
        } else {
          // Th√™m m·ªõi
          // Ki·ªÉm tra m√£ GD tr√πng
          if (giaoDichData.some((g) => g.maGd === maGd)) {
            formAlert.textContent = 'M√£ giao d·ªãch ƒë√£ t·ªìn t·∫°i.';
            formAlert.classList.remove('d-none');
            return;
          }
          giaoDichData.push(payload);
          alert('Th√™m giao d·ªãch th√†nh c√¥ng');
        }
        
        saveData();
        transactionModal.hide();
        loadGiaoDich();
      });

      // Kh·ªüi t·∫°o
      loadKhachHangOptions();
      loadSanPhamOptions();
      loadGiaoDich();
    </script>
  </body>
</html>